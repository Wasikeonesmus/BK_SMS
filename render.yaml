# Render Configuration for Upendo Bakery
# This file defines the infrastructure for the Django application

services:
  - type: web
    name: bk-sms
    env: python
    plan: free
    
    # Environment variables
    envVars:
      # Python configuration
      - key: PYTHON_VERSION
        value: 3.11.18  # Must match runtime.txt
      - key: PYTHONUNBUFFERED
        value: "1"
      - key: PYTHONHASHSEED
        value: "random"
      
      # Django configuration
      - key: DJANGO_SETTINGS_MODULE
        value: upendo_bakery.settings_prod
      - key: SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: "False"
      - key: ALLOWED_HOSTS
        value: "*"  # In production, replace with your domain
      
      # Database configuration
      - key: DATABASE_URL
        fromDatabase:
          name: bk-sms-db
          property: connectionString
        sync: true  # Ensure this is synced with the database
      
      # Static files configuration
      - key: DISABLE_COLLECTSTATIC
        value: "0"
      - key: WHITENOISE_AUTOREFRESH
        value: "1"
      
      # Application configuration
      - key: ENVIRONMENT
        value: production
      - key: PORT
        value: 10000
    
    # Build and start commands for Poetry
    buildCommand: |
      echo "ðŸš€ Starting build process..."
      python -m pip install --upgrade pip
      pip install poetry
      poetry install --no-dev --no-interaction --no-ansi
      python manage.py collectstatic --noinput
      python manage.py migrate
      
      # Create a simple health check endpoint
      mkdir -p staticfiles/health
      echo "<html><body><h1>Health Check</h1><p>OK</p></body></html>" > staticfiles/health/index.html
    
    # Using Procfile for start command to avoid duplication
    startCommand: ""
    
    # Health check path
    healthCheckPath: /health/
    
    # Auto-deploy from Git
    autoDeploy: true
    
    # Buildpacks for Python
    buildpacks:
      - https://github.com/heroku/heroku-buildpack-python
    
    # Resource allocation
    resources:
      cpu: 1
      memory: 1GB
      disk: 10GB

databases:
  - type: postgres
    name: bk-sms-db
    plan: free
    databaseName: upendo_bakery
    user: upendo_user
    forceNew: false
    # Enable backups
    backupRetention: 7
    # Allow connections from all IPs (for Render's internal networking)
    ipAllowList: []
    ipAllowList: []
    
    # Database configuration
    configuration:
      maxConnections: 100
      sharedBuffers: 100MB
      workMem: 10MB
      maintenanceWorkMem: 50MB
      maxParallelWorkers: 2
    
    # Backup settings
    backupRetentionDays: 7
    backupStartMinute: 0
    backupStartHour: 2
    backupDayOfWeek: 0  # Sunday